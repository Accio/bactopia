name: test-bactopia-conda

on: workflow_dispatch
  #schedule:
    # At 01:30 on Monday and Thursday
    #- cron:  '30 1 * * 1,4'

jobs:
  bactopia-testing-conda:
    runs-on: olaf
    defaults:
      run:
        shell: bash -l {0}
        working-directory: bactopia-${GITHUB_ACTION}-${GITHUB_JOB}
    steps:
      - name: Checkout bactopia/bactopia
        uses: actions/checkout@v2

      - name: Checkout bactopia/bactopia-tests
        uses: actions/checkout@v2
        with:
          repository: bactopia/bactopia-tests
          path: bactopia-tests

      - name: Run Bactopia Tests
        run: |
          BACTOPIA_CI=/data/storage/bactopia-ci
          BACTOPIA=$(pwd)
          source ${BACTOPIA_CI}/miniconda3/etc/profile.d/conda.sh
          mkdir ${GITHUB_WORKSPACE}/envs ${GITHUB_WORKSPACE}/pytest
          bash ${GITHUB_WORKSPACE}/bin/gh-actions/setup-bactopia-env.sh ${GITHUB_WORKSPACE} ${GITHUB_WORKSPACE} 0 "${GITHUB_WORKSPACE}/envs/bactopia-${GITHUB_JOB}" "bactopia-${GITHUB_JOB}"
          conda activate ${GITHUB_WORKSPACE}/envs/bactopia-${GITHUB_JOB}
          export PATH=${GITHUB_WORKSPACE}/envs/bactopia-${GITHUB_JOB}/bin:${PATH}
          uname -a && env
          BACTOPIA_ARGS="--condadir ${CONDA_CACHE} --test_data_dir ${GITHUB_WORKSPACE}/bactopia-tests/data" TMPDIR=${GITHUB_WORKSPACE}/pytest pytest --symlink --kwdof --ignore conda/ --ignore modules/local/bactopia-tools/ --tag bactopia

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: logs-debian
          path: |
            ${GITHUB_WORKSPACE}/pytest/pytest_workflow_*/*/log.out
            ${GITHUB_WORKSPACE}/pytest/pytest_workflow_*/*/log.err
